@model AppointmentVM


<div class="container">
    <h2>Schedule Your Appointment</h2>

   

    <form method="post">
        <div class="form-group">
            <label>Full Name:</label>
            <input type="text" asp-for="Appointment.Pname" class="form-control" required />
        </div>

        <div class="form-group">
            <label>Email Address:</label>
            <input type="email" asp-for="Appointment.Email" class="form-control" required />
        </div>

        <div class="form-group">
            <label>Appointment Date:</label>
            <input type="date" asp-for="Appointment.Date" class="form-control" required />
        </div>

        <div class="form-group">
            <label>Start Time:</label>
            <input type="time" asp-for="Appointment.Fromtime" class="form-control" required />
        </div>

        <div class="form-group">
            <label>End Time:</label>
            <input type="time" asp-for="Appointment.Totime" class="form-control" required />
        </div>

        <div class="form-group">
            <label>Select Doctor:</label>
            <select asp-for="Appointment.Did" class="form-control" required>
                <option disabled selected value="">-- Choose Doctor --</option>
            </select>
        </div>

        <div class="form-group">
            <label>Consultation Fee:</label>
            <input type="number" asp-for="Appointment.TotalCharge" class="form-control" readonly />
        </div>

        <div class="form-group">
            <label>GST (10%):</label>
            <input type="number" asp-for="Appointment.GST" class="form-control" readonly />
        </div>

        <div class="form-group">
            <label>Service Fee (5%):</label>
            <input type="number" asp-for="Appointment.ServiceCharge" class="form-control" readonly />
        </div>

        <div class="form-group">
            <label>Total Amount:</label>
            <input type="number" asp-for="Appointment.TotalAmount" class="form-control" readonly />
        </div>

        <button type="submit" asp-action="Index" class="btn btn-primary mt-3">Confirm Appointment</button>
    </form>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        $(document).ready(function () {
            @if (TempData["Message"] != null)
            {
                <text>
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: '@TempData["Message"]',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK'
                });
                </text>
            }

            @if (TempData["MessageError"] != null)
            {
                <text>
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: '@TempData["MessageError"]',
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'OK'
                });
                </text>
            }
        });
    </script>

    <script>

        $(document).ready(function() {
             
            $('#Appointment_Fromtime, #Appointment_Totime').on('change', function() {
                $('#Appointment_TotalCharge').val('');
                $('#Appointment_GST').val('');
                $('#Appointment_ServiceCharge').val('');
                $('#Appointment_TotalAmount').val('');
                $('#Appointment_Did').val('');
                var fromTime = $('#Appointment_Fromtime').val();
                var toTime = $('#Appointment_Totime').val();

                console.log("From Time: " + fromTime);
                console.log("To Time: " + toTime);
                debugger
                if (fromTime != "" && toTime != "") {
                    if( fromTime < toTime){
                    $.ajax({
                        url: "Home/GetAvailableDoctors?fromTime=" + fromTime + "&&toTime=" + toTime,
                        type: 'GET',
                        success: function(data) {
                            var doctorDropdown = $('#Appointment_Did');
                            doctorDropdown.empty();
                            doctorDropdown.append('<option disabled selected value="">-- Select Doctor --</option>');
                            console.log(data);
                            if (data.length > 0) {
                                data.forEach(function(doctor) {
                                    doctorDropdown.append('<option value="' + doctor.did + '">' + doctor.name + '</option>');
                                });
                            } else {  
                                Swal.fire({
                                title: "No Doctors Available",
                                text: "Based On the Your Input Time, Nearest Doctor is available from " + data.fromTime + " to " + data.toTime + ". Please choose within this time slot.",
                                icon: "warning",
                                showConfirmButton: true
                                    });
                            }
                        },
                        error: function() {
                            //alert("There was an error while checking doctor availability.");
                        }
                    });
                    }
                    else{
                        $('#Appointment_Totime').val('');
                        debugger
                        $('#Appointment_Did').val('');
                        Swal.fire({
                                title: "The End Time Must be After The Start Time",
                               // text: "Base On the Your Input Time doctors are available from " + data.fromTime + " to " + data.toTime + ". Please choose another time slot & date.",
                                icon: "warning",
                                showConfirmButton: true
                                    });
                        
                    }
                }
            });
        });

        $(document).ready(function() {
            $('#Appointment_Did,#Appointment_Date').on('change', function() {
                const today = new Date();
                const formattedDate = today.toLocaleDateString('en-CA'); // Format in "YYYY-MM-DD"
                console.log(formattedDate);
                debugger

                    var doctorId = $('#Appointment_Did').val();
                    var appointmentDate = $('#Appointment_Date').val();
                    var fromTime = $('#Appointment_Fromtime').val();
                    var toTime = $('#Appointment_Totime').val();
                    //var id = $('Appointment_AId').val();
                    //console.log(id);
                    debugger
                if(appointmentDate>=formattedDate)
                {

                    debugger
                    if (doctorId != null && appointmentDate != "" && fromTime != "" && toTime != "" ) {
                        $.ajax({
                            url: "Home/GetDoctorCharge?doctorId="+ doctorId +"&&appointmentDate="+ appointmentDate +"&&fromTime=" + fromTime + "&&toTime=" + toTime,
                            type: 'GET',
                            success: function(data) {
                                if (data > 0) {
                                    console.log(data);
                                    totalCharge = data;
                                    $('#Appointment_TotalCharge').val(totalCharge);
                                    GST = totalCharge * 10/100;
                                    $('#Appointment_GST').val(GST);
                                    service = totalCharge * 5/100;
                                    $('#Appointment_ServiceCharge').val(service);
                                    total = totalCharge + GST + service;
                                    $('#Appointment_TotalAmount').val(total);
                                } else {
                                    alert("No data found for the selected doctor and time.");
                                     //$('#Appointment_Date').val('');
                                }
                            },
                            error: function() {
                                alert("Error calculating the charge.");
                            }
                        });
                    }
                }
                 else
                 {
                     Swal.fire({
                                title: "Invalid Date",
                               text: "The selected date cannot be in the past. Please select a future date or Today.",
                                icon: "warning",
                                showConfirmButton: true
                                    });
                    $('#Appointment_Date').val('');
                    $('#Appointment_Fromtime').val('');
                    $('#Appointment_Totime').val('');
                 }
                    
            });
        });

     
    </script>

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Poppins', sans-serif;
        }

        .container {
            max-width: 600px;
            background: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-top: 50px;
        }

        h2 {
            text-align: center;
            color: #343a40;
            margin-bottom: 20px;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
        }

        .btn-primary {
            width: 100%;
            background: #007bff;
            border: none;
            padding: 10px;
            font-size: 16px;
            font-weight: 600;
            transition: 0.3s;
        }

            .btn-primary:hover {
                background: #0056b3;
            }
    </style>
}


